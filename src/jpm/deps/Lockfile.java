package jpm.deps;

import com.moandjiezana.toml.Toml;
import jpm.utils.FileUtils;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

public class Lockfile {
    
    private String version;
    private String configHash;
    private List<LockfileEntry> dependencies;
    
    public Lockfile() {
        this.version = "1";
        this.dependencies = new ArrayList<>();
    }
    
    public String getVersion() {
        return version;
    }
    
    public void setVersion(String version) {
        this.version = version;
    }
    
    public String getConfigHash() {
        return configHash;
    }
    
    public void setConfigHash(String configHash) {
        this.configHash = configHash;
    }
    
    public List<LockfileEntry> getDependencies() {
        return dependencies;
    }
    
    public void setDependencies(List<LockfileEntry> dependencies) {
        this.dependencies = dependencies;
    }
    
    public void addEntry(LockfileEntry entry) {
        this.dependencies.add(entry);
    }
    
    public static Lockfile load(File lockfile) throws IOException {
        if (!lockfile.exists()) {
            return null;
        }
        
        var toml = new Toml().read(lockfile);
        var lock = new Lockfile();
        
        lock.setVersion(toml.getString("version", "1"));
        lock.setConfigHash(toml.getString("config-hash"));
        
        var deps = toml.getTables("dependencies");
        if (deps != null) {
            for (var depToml : deps) {
                var entry = new LockfileEntry(
                    depToml.getString("group"),
                    depToml.getString("artifact"),
                    depToml.getString("version"),
                    depToml.getString("path")
                );
                lock.addEntry(entry);
            }
        }
        
        return lock;
    }
    
    public void save(File lockfile) throws IOException {
        var toml = new StringBuilder();
        toml.append("# This file is automatically generated by JPM.\n");
        toml.append("# It is not intended for manual editing.\n");
        toml.append("version = \"").append(version).append("\"\n");
        
        if (configHash != null) {
            toml.append("config-hash = \"").append(configHash).append("\"\n");
        }
        
        toml.append("\n");
        
        for (var entry : dependencies) {
            toml.append("[[dependencies]]\n");
            toml.append("group = \"").append(escape(entry.group())).append("\"\n");
            toml.append("artifact = \"").append(escape(entry.artifact())).append("\"\n");
            toml.append("version = \"").append(escape(entry.version())).append("\"\n");
            toml.append("path = \"").append(escape(entry.path())).append("\"\n");
            toml.append("\n");
        }
        
        FileUtils.writeFile(lockfile, toml.toString());
    }
    
    private static String escape(String value) {
        if (value == null) return "";
        return value.replace("\\", "\\\\").replace("\"", "\\\"").replace("\n", "\\n").replace("\r", "\\r").replace("\t", "\\t");
    }
    
    public List<DependencyResolver.ResolvedDependency> toResolvedDependencies() {
        var result = new ArrayList<DependencyResolver.ResolvedDependency>();
        for (var entry : dependencies) {
            var jarFile = new java.io.File(entry.path());
            if (jarFile.exists()) {
                result.add(new DependencyResolver.ResolvedDependency(
                    entry.group(),
                    entry.artifact(),
                    entry.version(),
                    jarFile
                ));
            }
        }
        return result;
    }
    
    public static Lockfile fromResolvedDependencies(List<DependencyResolver.ResolvedDependency> deps, String configHash) {
        var lockfile = new Lockfile();
        lockfile.setConfigHash(configHash);
        for (var dep : deps) {
            var entry = new LockfileEntry(
                dep.groupId(),
                dep.artifactId(),
                dep.version(),
                dep.jarFile().getAbsolutePath()
            );
            lockfile.addEntry(entry);
        }
        return lockfile;
    }
    
    // Java 16+ record for lockfile entry information
    public record LockfileEntry(String group, String artifact, String version, String path) {
    }
}
