package jpm.deps;

import com.moandjiezana.toml.Toml;
import jpm.utils.FileUtils;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class Lockfile {
    
    private String version;
    private String configHash;
    private List<LockfileEntry> dependencies;
    
    public Lockfile() {
        this.version = "1";
        this.dependencies = new ArrayList<>();
    }
    
    public String getVersion() {
        return version;
    }
    
    public void setVersion(String version) {
        this.version = version;
    }
    
    public String getConfigHash() {
        return configHash;
    }
    
    public void setConfigHash(String configHash) {
        this.configHash = configHash;
    }
    
    public List<LockfileEntry> getDependencies() {
        return dependencies;
    }
    
    public void setDependencies(List<LockfileEntry> dependencies) {
        this.dependencies = dependencies;
    }
    
    public void addEntry(LockfileEntry entry) {
        this.dependencies.add(entry);
    }
    
    public static Lockfile load(File lockfile) throws IOException {
        if (!lockfile.exists()) {
            return null;
        }
        
        Toml toml = new Toml().read(lockfile);
        Lockfile lock = new Lockfile();
        
        lock.setVersion(toml.getString("version", "1"));
        lock.setConfigHash(toml.getString("config-hash"));
        
        List<Toml> deps = toml.getTables("dependencies");
        if (deps != null) {
            for (Toml depToml : deps) {
                LockfileEntry entry = new LockfileEntry();
                entry.setGroup(depToml.getString("group"));
                entry.setArtifact(depToml.getString("artifact"));
                entry.setVersion(depToml.getString("version"));
                entry.setPath(depToml.getString("path"));
                lock.addEntry(entry);
            }
        }
        
        return lock;
    }
    
    public void save(File lockfile) throws IOException {
        StringBuilder toml = new StringBuilder();
        toml.append("# This file is automatically generated by JPM.\n");
        toml.append("# It is not intended for manual editing.\n");
        toml.append("version = \"").append(version).append("\"\n");
        
        if (configHash != null) {
            toml.append("config-hash = \"").append(configHash).append("\"\n");
        }
        
        toml.append("\n");
        
        for (LockfileEntry entry : dependencies) {
            toml.append("[[dependencies]]\n");
            toml.append("group = \"").append(escape(entry.getGroup())).append("\"\n");
            toml.append("artifact = \"").append(escape(entry.getArtifact())).append("\"\n");
            toml.append("version = \"").append(escape(entry.getVersion())).append("\"\n");
            toml.append("path = \"").append(escape(entry.getPath())).append("\"\n");
            toml.append("\n");
        }
        
        FileUtils.writeFile(lockfile, toml.toString());
    }
    
    private static String escape(String value) {
        if (value == null) return "";
        return value.replace("\\", "\\\\").replace("\"", "\\\"").replace("\n", "\\n").replace("\r", "\\r").replace("\t", "\\t");
    }
    
    public List<DependencyResolver.ResolvedDependency> toResolvedDependencies() {
        List<DependencyResolver.ResolvedDependency> result = new ArrayList<>();
        for (LockfileEntry entry : dependencies) {
            java.io.File jarFile = new java.io.File(entry.getPath());
            if (jarFile.exists()) {
                result.add(new DependencyResolver.ResolvedDependency(
                    entry.getGroup(),
                    entry.getArtifact(),
                    entry.getVersion(),
                    jarFile
                ));
            }
        }
        return result;
    }
    
    public static Lockfile fromResolvedDependencies(List<DependencyResolver.ResolvedDependency> deps, String configHash) {
        Lockfile lockfile = new Lockfile();
        lockfile.setConfigHash(configHash);
        for (DependencyResolver.ResolvedDependency dep : deps) {
            LockfileEntry entry = new LockfileEntry();
            entry.setGroup(dep.groupId);
            entry.setArtifact(dep.artifactId);
            entry.setVersion(dep.version);
            entry.setPath(dep.jarFile.getAbsolutePath());
            lockfile.addEntry(entry);
        }
        return lockfile;
    }
    
    public static class LockfileEntry {
        private String group;
        private String artifact;
        private String version;
        private String path;
        
        public String getGroup() {
            return group;
        }
        
        public void setGroup(String group) {
            this.group = group;
        }
        
        public String getArtifact() {
            return artifact;
        }
        
        public void setArtifact(String artifact) {
            this.artifact = artifact;
        }
        
        public String getVersion() {
            return version;
        }
        
        public void setVersion(String version) {
            this.version = version;
        }
        
        public String getPath() {
            return path;
        }
        
        public void setPath(String path) {
            this.path = path;
        }
    }
}
